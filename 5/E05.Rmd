---
title: "E05: Artificial neural networks in medicine"
author: "<br> &#169; <i>Коллектив авторов, 2023</i>"
date: "2023-07-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***ВСЁ** выделенное курсивом предназначено для пояснения задачи и подлежит удалению (или замене на нужные данные, с убиранием курсива) при формировании окончательного html-документа.*

*Данный шаблон (темплет, англ. template) является основой для выполнения практического задания по материалам раздела № 5. Он позволяет выполнить создание простейшей искусственной нейронной сети.*

*После каждой формулировки вопроса, представлен блок кода (чанк) с соответствующими настройками вывода (первая строка в {} скобках, ЕЕ РЕДАКТИРОВАТЬ НЕ НАДО), в который вы должны вставить решение, с использованием языка R. Примеры кода, для решения имеются в соответствующем разделе пособия.*

*Результатом вашей работы должен стать html-документ, содержащий заголовок (в котором необходимо отобразить свои учетные данные - номер факультета, курса, группы, ФИО и т.д.), формулировки вопросов, коды их решения и полученные результаты. В дальнейшем эти html-документы будут объединены в отчет о выполнении индивидуального задания за семестр.*

*Обратите внимание, что в программном коде, приведенном ниже создается подмножество переменных, согласно тех исходных данных, которые вам назначит преподаватель (group == "номер варианта"), поэтому результаты расчетов в большинстве будут отличаться от тех, что получатся у других обучающихся. Этот код не выводится в отчетный документ. Имя формируемого подмножества переменных `MedRecord_nns_XX`, где "ХХ" - номер варианта задаваемого преподавателем. Этот же номер включается в запрос как `group == "ХХ"` для формирования учебного набора данных для конкретного обучаемого. Например, если вариант имеет номер "34", команда R для отбора данных будет выглядеть следующим образом:*

```         
MedRecord_nns_34 <- subset(medrwork::MedRecord, group == "34",
select = c(cid, age, gender, weight, height, lungcap, smoke, HEALTH, TRUD, MILSPECIALTY))
```

*В большинстве вопросов этого задания вы будете брать данные из `MedRecord_nns_XX`. Чанки, относящиеся к вопросам должны содержать написанные вами коды их решения.*

```{r subset_s6, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Этот код не исполняется,а является образцом для создания вашего подмножества данных!!!
# 1. создание подмножества переменных и строк из исходной таблицы с помощью функции subset() (и ее аргументов, при необходимости); 
MedRecord_nns_XX <- subset(medrwork::MedRecord, #group == 1
select = c(gender01, age, HEALTH, p_sick))

# 2. экспорт этого подмножества в файл `*.csv` в рабочую папку; 
write.csv(MedRecord_nns_XX, "./data/MedRecord_nns_XX.csv", row.names=FALSE, fileEncoding="UTF-8")

# 3. импорт набора данных из этого файла `*.csv`в рабочую среду (Environment) R. 
MedRecord_nns_XX <- Hmisc::csv.get("./data/MedRecord_nns_XX.csv",
                                      vnames=1, # первая строка в csv - имена переменных
                                      skip=1, # пропуск первой строки (имена переменных)
                                      sep=",", # разделитель в Excel для csv - ";"
                                      allow = FALSE) #позволит вам получить исходные имена.

```

::: {align="center"}
## Практическое задание № 5

**практики**: Научно-исследовательская работа

**на тему:** Искусственный интеллект в статистике: искусственные нейронные сети.

**обучающегося:** *Иванова И.И.*

*000* **факультета** *000* **курса** *00-000* **группы**

**по специальности:** *Лечебное дело*

**номер варианта:** *000*

**дата выполнения:** *00.00.00* г.
:::

------------------------------------------------------------------------

## Задание для самостоятельного решения

В поликлинике в/ч № 00000 ведутся записи посещения пациентов приходящих на приём к врачу, а также результаты углубленных медицинских осмотров военнослужащих части в медицинских книжках. Смоделированы исходы "Ощущение нездоровья". Модель, описывающая наличие ощущения "нездоровья" (переменная `sick`) в зависимости от пола `gender01` ($\beta$=-0,7, т.е. у мужчин ощущение нездоровья меньше, чем у женщин ), возраста `age` ($\beta$=-0.1, на каждый год уменьшение в 1.1 раза, 10%) и оценки (группы) состояния здоровья `HEALTH` ($\beta$=-0.5, в 1.6 раза уменьшается с увеличение на один уровень оценки в худшую сторону) . Увеличение в модели свободного члена (`intercept`) увеличивает долю исходов = 1. Линейный предиктор для переменной исхода `sick`. Построите диаграмму нейронной сети. Постройте графики отражающие процесс моделирования.

Для решения примера воспользуйтесь "Медицинскими записями о здоровье военнослужащих в/ч № 00000 за календарный год" представленые в файле MedRecord.csv в соответствии со своим вариантом.

------------------------------------------------------------------------

### Вопрос 1. Сформируйте таблицу исходя из номера вашего варианта для создания набора данных.

```{r print-limit, exercise=TRUE, exercise.eval=TRUE}
install.packages("./medrwork", repos = NULL, type = "source")
install.packages("Hmisc", repos = "https://cloud.r-project.org/")

# Загрузка необходимых библиотек
library(medrwork)
library(Hmisc)

# Создание подмножества данных для варианта 1
MedRecord_nns_1 <- subset(medrwork::MedRecord, group == 1,
                          select = c(gender01, age, HEALTH, p_sick))

# Экспорт подмножества данных в файл CSV
write.csv(MedRecord_nns_1, "./data/MedRecord_nns_1.csv", row.names=FALSE, fileEncoding="UTF-8")

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- Hmisc::csv.get("./data/MedRecord_nns_1.csv",
                                  vnames=1, # первая строка в csv - имена переменных
                                  skip=1, # пропуск первой строки (имена переменных)
                                  sep=",", # разделитель в Excel для csv - ","
                                  allow = FALSE) #позволит вам получить исходные имена.

# Просмотр первых строк полученного набора данных
head(MedRecord_nns_1)
```

### Вопрос 2. Отбор переменных и строк из набора данных для статистического анализа

Напишите *R* код, необходимый для cоздания набора данных для обучения и тестирования нейронной сети и нормализуйте их с помощью функции *scaled*.

```{r echo = TRUE}
# Нормализация данных с помощью функции scale
MedRecord_nns_1_scaled <- as.data.frame(scale(MedRecord_nns_1))

# Просмотр первых строк нормализованного набора данных
head(MedRecord_nns_1_scaled)
```

### Вопрос 3. Выполните подгонку (обучение) нейронной сети и определите веса в нейронной сети.

Напишите *R* код, необходимый для обучения нейронной сети и определения весов на дугах графа состояния нейронной сети.

```{r echo = TRUE}
# Установка и загрузка необходимых библиотек
install.packages("neuralnet", repos = "https://cloud.r-project.org/")
library(neuralnet)

# Используем нормализованные данные из предыдущего шага
# Предположим, что переменная p_sick является целевой переменной (sick)

# Переименуем переменную p_sick в sick для удобства
MedRecord_nns_1_scaled$sick <- MedRecord_nns_1_scaled$p_sick
MedRecord_nns_1_scaled$p_sick <- NULL

# Просмотр первых строк нормализованного набора данных
head(MedRecord_nns_1_scaled)

# Определение формулы для нейронной сети
formula <- sick ~ gender01 + age + HEALTH

# Обучение нейронной сети
set.seed(123) # Установка начального значения для воспроизводимости результатов
nn <- neuralnet(formula, data = MedRecord_nns_1_scaled, hidden = c(5, 3), linear.output = FALSE)

# Определение весов в нейронной сети
nn$weights
```
### Вопрос 4. Постройте диаграмму нейронной сети.

Напишите *R* код, необходимый для графического постоения графа состояния отображающего нейронную сеть.

```{r echo = TRUE}
# Установка и загрузка необходимых библиотек
install.packages("neuralnet", repos = "https://cloud.r-project.org/")
library(neuralnet)

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- read.csv("./data/MedRecord_nns_1.csv", fileEncoding="UTF-8")

# Нормализация данных с помощью функции scale
MedRecord_nns_1_scaled <- as.data.frame(scale(MedRecord_nns_1))

# Переименуем переменную p_sick в sick для удобства
MedRecord_nns_1_scaled$sick <- MedRecord_nns_1_scaled$p_sick
MedRecord_nns_1_scaled$p_sick <- NULL

# Просмотр первых строк нормализованного набора данных
head(MedRecord_nns_1_scaled)

# Определение формулы для нейронной сети
formula <- sick ~ gender01 + age + HEALTH

# Обучение нейронной сети
set.seed(123) # Установка начального значения для воспроизводимости результатов
nn <- neuralnet(formula, data = MedRecord_nns_1_scaled, hidden = c(5, 3), linear.output = FALSE)

# Визуализация нейронной сети
plot(nn, rep = "best")
```

### Вопрос 5. Преобразуйте вероятности в бинарные классы с установкой порогового уровня.

Напишите *R* код, необходимый для преобразования бинарных классов нейронной сети и установления порогового значения

```{r echo = TRUE}
# Установка и загрузка необходимых библиотек
install.packages("neuralnet", repos = "https://cloud.r-project.org/")
library(neuralnet)

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- read.csv("./data/MedRecord_nns_1.csv", fileEncoding="UTF-8")

# Нормализация данных с помощью функции scale
MedRecord_nns_1_scaled <- as.data.frame(scale(MedRecord_nns_1))

# Переименуем переменную p_sick в sick для удобства
MedRecord_nns_1_scaled$sick <- MedRecord_nns_1_scaled$p_sick
MedRecord_nns_1_scaled$p_sick <- NULL

# Просмотр первых строк нормализованного набора данных
head(MedRecord_nns_1_scaled)

# Определение формулы для нейронной сети
formula <- sick ~ gender01 + age + HEALTH

# Обучение нейронной сети
set.seed(123) # Установка начального значения для воспроизводимости результатов
nn <- neuralnet(formula, data = MedRecord_nns_1_scaled, hidden = c(5, 3), linear.output = FALSE)

# Визуализация нейронной сети
plot(nn, rep = "best")

# Получение предсказаний от обученной нейронной сети
predictions <- compute(nn, MedRecord_nns_1_scaled[, c("gender01", "age", "HEALTH")])$net.result

# Установка порогового значения
threshold <- 0.5

# Преобразование вероятностей в бинарные классы
binary_predictions <- ifelse(predictions > threshold, 1, 0)

# Просмотр первых строк бинарных предсказаний
head(binary_predictions)
```

### Вопрос 6. Выполните этап прогнозирования с использованием нейросети.

Напишите *R* код, необходимый для выполнения этапа прогнозирования и установления порогового значения

```{r echo = TRUE}
# Установка и загрузка необходимых библиотек
install.packages("neuralnet", repos = "https://cloud.r-project.org/")
library(neuralnet)

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- read.csv("./data/MedRecord_nns_1.csv", fileEncoding="UTF-8")

# Нормализация данных с помощью функции scale
MedRecord_nns_1_scaled <- as.data.frame(scale(MedRecord_nns_1))

# Переименуем переменную p_sick в sick для удобства
MedRecord_nns_1_scaled$sick <- MedRecord_nns_1_scaled$p_sick
MedRecord_nns_1_scaled$p_sick <- NULL

# Определение формулы для нейронной сети
formula <- sick ~ gender01 + age + HEALTH

# Обучение нейронной сети
set.seed(123) # Установка начального значения для воспроизводимости результатов
nn <- neuralnet(formula, data = MedRecord_nns_1_scaled, hidden = c(5, 3), linear.output = FALSE)

# Визуализация нейронной сети
plot(nn, rep = "best")

# Получение предсказаний от обученной нейронной сети
predictions <- compute(nn, MedRecord_nns_1_scaled[, c("gender01", "age", "HEALTH")])$net.result

# Установка порогового значения
threshold <- 0.5

# Преобразование вероятностей в бинарные классы
binary_predictions <- ifelse(predictions > threshold, 1, 0)

# Просмотр первых строк бинарных предсказаний
head(binary_predictions)

# Добавление предсказаний к исходным данным для анализа
MedRecord_nns_1_scaled$predicted_sick <- binary_predictions

# Просмотр первых строк данных с предсказаниями
head(MedRecord_nns_1_scaled)
```

### Вопрос 7. Постройте график зависимости прогнозируемых значений от реальных.

Напишите *R* код, необходимый для построения графика зависимости прогнозируемых значений от реальных значений выработки решений нейронной сетью.

```{r echo = TRUE}
# Установка и загрузка необходимых библиотек
install.packages("neuralnet", repos = "https://cloud.r-project.org/")
library(neuralnet)

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- read.csv("./data/MedRecord_nns_1.csv", fileEncoding="UTF-8")

# Нормализация данных с помощью функции scale
MedRecord_nns_1_scaled <- as.data.frame(scale(MedRecord_nns_1))

# Переименуем переменную p_sick в sick для удобства
MedRecord_nns_1_scaled$sick <- MedRecord_nns_1_scaled$p_sick
MedRecord_nns_1_scaled$p_sick <- NULL

# Определение формулы для нейронной сети
formula <- sick ~ gender01 + age + HEALTH

# Обучение нейронной сети
set.seed(123) # Установка начального значения для воспроизводимости результатов
nn <- neuralnet(formula, data = MedRecord_nns_1_scaled, hidden = c(5, 3), linear.output = FALSE)

# Визуализация нейронной сети
plot(nn, rep = "best")

# Получение предсказаний от обученной нейронной сети
predictions <- compute(nn, MedRecord_nns_1_scaled[, c("gender01", "age", "HEALTH")])$net.result

# Установка порогового значения
threshold <- 0.5

# Преобразование вероятностей в бинарные классы
binary_predictions <- ifelse(predictions > threshold, 1, 0)

# Просмотр первых строк бинарных предсказаний
head(binary_predictions)

# Добавление предсказаний к исходным данным для анализа
MedRecord_nns_1_scaled$predicted_sick <- binary_predictions

# Просмотр первых строк данных с предсказаниями
head(MedRecord_nns_1_scaled)

# Построение графика зависимости прогнозируемых значений от реальных
plot(MedRecord_nns_1_scaled$sick, predictions, 
     xlab = "Реальные значения", ylab = "Прогнозируемые значения", 
     main = "Зависимость прогнозируемых значений от реальных", 
     col = "blue", pch = 16, xlim = c(0, 1), ylim = c(0, 1))
abline(0, 1, col = "red")
```

## Справочные материалы

Для выполнения задания Вы можете использовать R коды из материалов соответствующего раздела.
