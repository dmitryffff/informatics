---
title: "E06: Queuing systems in medicine"
author: "<br> &#169; <i>Коллектив авторов, 2023</i>"
date: "2023-07-21"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***ВСЁ** выделенное курсивом предназначено для пояснения задачи и
подлежит удалению (или замене на нужные данные, с убиранием курсива) при
формировании окончательного html-документа.*

*Данный шаблон (темплет, англ. template) является основой для выполнения
практического задания по материалам раздела № 6. Он позволяет создать
сетевую модель для систем массового обслуживания(СМО) и моделировать
режимы её работы.*

*После каждой формулировки вопроса, представлен блок кода (чанк) с
соответствующими настройками вывода (первая строка в {} скобках, ЕЕ
РЕДАКТИРОВАТЬ НЕ НАДО), в который вы должны вставить решение, с
использованием языка R. Примеры кода, для решения имеются в
соответствующем разделе пособия.*

*Результатом вашей работы должен стать html-документ, содержащий
заголовок (в котором необходимо отобразить свои учетные данные - номер
факультета, курса, группы, ФИО и т.д.), формулировки вопросов, коды их
решения и полученные результаты. В дальнейшем эти html-документы будут
объединены в отчет о выполнении индивидуального задания за семестр.*

*Обратите внимание, что в программном коде, приведенном ниже создается
подмножество переменных, согласно тех исходных данных, которые вам
назначит преподаватель (group == "номер варианта"), поэтому результаты
расчетов в большинстве будут отличаться от тех, что получатся у других
обучающихся. Этот код не выводится в отчетный документ. Имя формируемого
подмножества переменных `MedRecord_QS_ХХ`, где "ХХ" - номер варианта
задаваемого преподавателем. Этот же номер включается в запрос как
`group == "ХХ"` для формирования учебного набора данных для конкретного
обучаемого. Например, если вариант имеет номер "34", команда R для
отбора данных будет выглядеть следующим образом:*

    MedRecord_QS_34 <- subset(medrwork::MedRecord, group == "34",
    select = c(cid, age, gender, weight, height, lungcap, smoke, HEALTH, TRUD, MILSPECIALTY))

*В большинстве вопросов этого задания вы будете брать данные из
`MedRecord_QS_XX`. Чанки, относящиеся к вопросам должны содержать
написанные вами коды их решения.*

```{r subset_s6, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Этот код не исполняется,а является образцом для создания вашего подмножества данных!!!
# 1. создание подмножества переменных и строк из исходной таблицы с помощью функции subset() (и ее аргументов, при необходимости); 
MedRecord_QS <- subset(medrwork::MedRecord, group == "1", # вместо ХХ - укажите число,которое вам назначил преподаватель
                       select = c(badday, StacOut))

# 2. экспорт этого подмножества в файл `*.csv` в рабочую папку; 
write.csv(MedRecord_QS, "./data/MedRecord_QS_XX.csv", row.names=FALSE, fileEncoding="UTF-8")

# 3. импорт набора данных из этого файла `*.csv`в рабочую среду (Environment) R. 
MedRecord_QS <- Hmisc::csv.get("./data/MedRecord_QS_XX.csv",
                                      vnames=1, # первая строка в csv - имена переменных
                                      skip=1, # пропуск первой строки (имена переменных)
                                      sep=",", # разделитель в Excel для csv - ";"
                                      allow = FALSE) #позволит вам получить исходные имена.


```

::: {align="center"}
## Практическое задание № 6

**практики**: Научно-исследовательская работа

**на тему:** Моделирование систем массового обслуживания (в медицине):
сетевые модели.

**обучающегося:** *Иванова И.И.*

*000* **факультета** *000* **курса** *00-000* **группы**

**по специальности:** *Лечебное дело*

**номер варианта:** *000*

**дата выполнения:** *00.00.00* г.
:::

------------------------------------------------------------------------

## Задание для самостоятельного решения

Поликлиника в/ч № 00000 функционирует с 9-00 до 13-00. При прибытии
пациента его сначала осматривает медсестра для приема, затем врач для
консультации и, наконец, регистратор регистратуры для записи на
повторный прием. В поликлинике может принимать 1 врач или 2 врача.
Медсестра и регистратор, может обслужить одного пациента , врач, двоих
.Время между пациентами составляет 20 минут. Проанализируйте эту
систему. Постройте граф состояния. Смоделируйте работу поликлиники для
построения расписания работы врача. Для решения примера воспользуйтесь
"Медицинскими записями о здоровье военнослужащих в/ч № 00000 за
календарный год" представленые в файле dtMedRecord.csv. в соответствии
со своим вариантом выберете месяц работы поликлиники.

------------------------------------------------------------------------

### Вопрос 1. Постройте граф состояния отображающий работу СМО при приёме врача.

С помощью библиотеки *grViz* нарисуйте граф состояния (схему работы)
системы обслуживания СМО.

```{r print-limit, exercise=TRUE, exercise.eval=TRUE}
install.packages("DiagrammeR")
library(DiagrammeR)

grViz("
digraph G {
  rankdir=LR;
  
  node [shape = rectangle, style=filled, color=lightblue];
  
  start [label = 'Начало'];
  nurse [label = 'Осмотр медсестрой'];
  doctor [label = 'Консультация врача'];
  registrar [label = 'Запись у регистратора'];
  end [label = 'Конец'];
  
  start -> nurse [label = 'Пациент прибыл'];
  nurse -> doctor [label = 'Осмотр завершен'];
  doctor -> registrar [label = 'Консультация завершена'];
  registrar -> end [label = 'Запись завершена'];
}
")
```

### Вопрос 2. Отбор переменных и строк из набора данных для статистического анализа

2.1. Напишите код R, необходимый для отбора из исходного набора данных
`MedRecord` в таблицу `MedRecord_stat_ХХ` переменных `month`,
`sum_contact`. Группа - `group == "назначенный вам вариант"`.

```{r echo = TRUE}
install.packages("./medrwork", repos = NULL, type = "source")
install.packages("Hmisc", repos = "https://cloud.r-project.org/")

# Загрузка необходимых библиотек
library(medrwork)
library(Hmisc)

# Создание подмножества данных для варианта 1
MedRecord_nns_1 <- subset(medrwork::MedRecord, group == 2)

# Экспорт подмножества данных в файл CSV
write.csv(MedRecord_nns_1, "./data/MedRecord_nns_1.csv", row.names=FALSE, fileEncoding="UTF-8")

# Импорт набора данных из файла CSV обратно в рабочую среду R
MedRecord_nns_1 <- Hmisc::csv.get("./data/MedRecord_nns_1.csv",
                                  vnames=1, # первая строка в csv - имена переменных
                                  skip=1, # пропуск первой строки (имена переменных)
                                  sep=",", # разделитель в Excel для csv - ","
                                  allow = FALSE) #позволит вам получить исходные имена.

# Просмотр первых строк полученного набора данных
head(medrwork::MedRecord)
```

2.2. Агрегируйте количество дней лечения (контактов) по месяцам,
выберете в соответствии с вашим индивидуальным вариантом месяц на основе
которого будут выбраны входные параметры для модели СМО ( ***λ*** --
скорость поступления клиентов в систему и ***μ*** -- скорость
обслуживания ). Выведите на экран созданную таблицу `agg_contact`

```{r echo = TRUE}

```

### Вопрос 3. Смоделируйте работу СМО, выведите описание модели с возможностью выбора параметров при работе 1 врача.

Используя библиотеку *queueing* создайте объект класса очереди с помощью
функции *QueueingModel* для СМО класса М/М/1 и с помощью функции *t*
выведите описание модели с возможностью выбора параметров.


```{r echo = TRUE}


```

### Вопрос 4. Смоделируйте работу СМО, выведите описание модели с возможностью выбора параметров при работе 2 врачей.

Используя библиотеку *queueing* создайте объект класса очереди с помощью
функции *QueueingModel* для СМО класса М/М/n и с помощью функции *t*
выведите описание модели с возможностью выбора параметров.

```{r echo = TRUE}


```

### Вопрос 5. Выведте графики зависимости распределение случайных величин ожидания СМО при работе 1 врача , при работе 2 врачей.

Напишите *R* код, необходимый для построения графика зависимости
распределения случайных величин ожидания обслуживания заявки (среднего
времени нахождения заявки в системе и среднего времени нахождения заявки
в очереди) для СМО класса М/М/1 и М/М/n.

```{r echo = TRUE}
 

```

### Вопрос 6. Смоделируйте дискретные события в СМО и процесс движения пациента для построения расписания работы врача.

Напишите *R* код, необходимый для моделирования процессов происходящих в
СМО класса М/М/1 используя библиотеку *simmer*, которая используется для
моделирования дискретных событий в СМО.

```{r echo = TRUE}


```

### Вопрос 7. Выведите графики загрузки персонала поликлиники в СМО в зависимости от входного потока пациентов.

Напишите *R* код, необходимый для построения графиков загрузки персонала
поликлиники в/ч 00000 в зависимости от входного потока пациентов с
применением функции *simmer.plot* .

```{r echo = TRUE}


```

## Справочные материалы.

Для выполнения задания Вы можете использовать R коды из материалов
соответствующего раздела.
